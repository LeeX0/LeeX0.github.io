---
title: 'Linux:进程与线程、文件描述符与重定向(补)'
tags:
  - - Linux
  - - 进程
  - - 线程
  - - 文件描述符
  - - 重定向
categories:
  - [学习笔记, Linux]
abbrlink: 991f3e43
date: 2020-12-19 19:35:49
---

### Q1：与Windows下进程线程区别？

Windows中`进程`只是作为**资源的拥有者**，并不是实际任务的执行者，**实际的执行**靠`线程`实现。

一个进程可以拥有多个线程，多个线程共享进程拥有的资源，同时可能具有自己的独占资源。在具体执行任务时由线程来使用处理机。 

Windows中，进程实现靠createProcess实现。而createProcess有一大堆的参数，不过很多时候都默认为null。其作用相当于创建一个进程的同时创建一个线程（一般一个）。

而Linux中**在 Linux 系统中，进程和线程几乎没有区别**。

进程和线程都是实际运行的存在，都有一个类似的进程描述符（而Windows中线程不具有进程描述符，只描述一些少量的独有资源，所以很轻量）。

*线程看起来跟进程没有区别，只是线程的某些数据区域和其父进程是共享的，而子进程是拷贝副本，而不是共享*。

### Q2：如何理解Linux shell中的“2>&1”？

```bash
./test.sh  > log.txt 2>&1
```

上面的调用表明将`./test.sh`的输出重定向到`log.txt`文件中，同时将标准错误也重定向到`log.txt`文件中。

每个程序在运行后，都会至少打开三个文件描述符，分别是0：标准输入；1：标准输出；2：标准错误。例如，对于前面的test.sh脚本它至少打开了三个文件描述符（可以在`/proc/<pid>/fd`目录下查到）。

那么现在就容易理解前面的疑问了，`2>&1`表明将文件描述2（标准错误输出）的内容重定向到文件描述符1（标准输出），为什么1前面需要&？当没有&时，1会被认为是一个普通的文件，**有&表示重定向的目标不是一个文件，而是一个文件描述符**。在前面我们知道，test.sh >log.txt又将文件描述符1的内容重定向到了文件log.txt，那么最终标准错误也会重定向到log.txt。

可以在`/proc/<pid>/fd`目录下查到重定向的情况文件，**文件描述符1和2都指向了log.txt文件，**也就得到了我们最终想要的效果：**将标准错误输出重定向到文件中**。

> 程序运行后会打开三个文件描述符，分别是标准输入，标准输出和标准错误输出。
>
> 在调用脚本时，可使用2>&1来将标准错误输出重定向。
>
> 只需要查看脚本的错误时，可将标准输出重定向到文件，而标准错误会打印在控制台，便于查看。
>
> `>>log.txt`会将重定向内容追加到log.txt文件末尾。
>
> 通过查看`/proc/<pid>/fd`下的内容，可了解进程打开的文件描述符信息。

### Q3：为什么`command > file 2>&1 `不可以？

- 对于`command > file 2>&1`:

```bash
 # 初始状态
 0 -> /dev/pts/7
 1 -> /dev/pts/7
 2 -> /dev/pts/7
```

首先是`command > file`将标准输出重定向到`file`中。

```bash
 # command > file
 0 -> /dev/pts/7
 1 -> file
 2 -> /dev/pts/7
```

`2>&1`是标准错误拷贝了标准输出的行为，也就是同样被重定向到`file`中。

```bash
 # 2>&1
 0 -> /dev/pts/7
 1 -> file
 2 -> file
```

最终结果就是标准输出和错误都被重定向到file中，正确。

- 而对于`command 2>&1 >file 2>&1`:

```bash
 # 初始状态
 0 -> /dev/pts/7
 1 -> /dev/pts/7
 2 -> /dev/pts/7
```

首先是`2>&1`，**标准错误拷贝了标准输出的行为，但此时标准输出还是在终端**。

```bash
 # 2>&1
 0 -> /dev/pts/7
 1 -> /dev/pts/7
 2 -> /dev/pts/7
```

`>file`后输出才被重定向到file，但标准错误仍然保持在终端。

```bash
 # 2>&1
 0 -> /dev/pts/7
 1 -> file
 2 -> /dev/pts/7
```

所以达不到标准错误输出重定向的效果。

---

> 参考：
>
> https://zhuanlan.zhihu.com/p/47765176