<!DOCTYPE html><html lang="en" data-default-color-scheme="&#34;auto&#34;"><head><meta charset="UTF-8"><link rel="apple-touch-icon" sizes="76x76" href="/img/favicon.png"><link rel="icon" href="/img/favicon.png"><meta name="viewport" content="width=device-width,initial-scale=1,maximum-scale=1,user-scalable=no,shrink-to-fit=no"><meta http-equiv="x-ua-compatible" content="ie=edge"><meta name="theme-color" content="#2f4154"><meta name="description" content=""><meta name="author" content="LeeX0"><meta name="keywords" content=""><title>Makefile应知应会 - LeeX0&#39;s blog</title><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@4.5.3/dist/css/bootstrap.min.css"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/github-markdown-css@4.0.0/github-markdown.min.css"><link rel="stylesheet" href="/lib/hint/hint.min.css"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/prismjs@1.22.0/themes/prism.min.css"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/prismjs@1.22.0/plugins/line-numbers/prism-line-numbers.min.css"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@fancyapps/fancybox@3.5.7/dist/jquery.fancybox.min.css"><link rel="stylesheet" href="//at.alicdn.com/t/font_1749284_ba1fz6golrf.css"><link rel="stylesheet" href="//at.alicdn.com/t/font_1736178_kmeydafke9r.css"><link rel="stylesheet" href="/css/main.css"><script id="fluid-configs">var Fluid=window.Fluid||{},CONFIG={hostname:"leex0.top",root:"/",version:"1.8.9-a",typing:{enable:!0,typeSpeed:60,cursorChar:"_",loop:!1},anchorjs:{enable:!0,element:"h1,h2,h3,h4,h5,h6",placement:"right",visible:"hover",icon:""},progressbar:{enable:!0,height_px:3,color:"#29d",options:{showSpinner:!1,trickleSpeed:100}},copy_btn:!0,image_zoom:{enable:!0},toc:{enable:!0,headingSelector:"h1,h2,h3,h4,h5,h6",collapseDepth:1},lazyload:{enable:!0,loading_img:"/img/loading.gif",onlypost:!1,offset_factor:2},web_analytics:{enable:!1,baidu:null,google:null,gtag:null,tencent:{sid:null,cid:null},woyaola:null,cnzz:null,leancloud:{app_id:null,app_key:null,server_url:null}}}</script><script src="/js/utils.js"></script><script src="/js/color-schema.js"></script><meta name="generator" content="Hexo 5.4.0"></head><body><header style="height:70vh"><nav id="navbar" class="navbar fixed-top navbar-expand-lg navbar-dark scrolling-navbar"><div class="container"><a class="navbar-brand" href="/">&nbsp;<strong>LeeX0's blog</strong>&nbsp;</a> <button id="navbar-toggler-btn" class="navbar-toggler" type="button" data-toggle="collapse" data-target="#navbarSupportedContent" aria-controls="navbarSupportedContent" aria-expanded="false" aria-label="Toggle navigation"><div class="animated-icon"><span></span><span></span><span></span></div></button><div class="collapse navbar-collapse" id="navbarSupportedContent"><ul class="navbar-nav ml-auto text-center"><li class="nav-item"><a class="nav-link" href="/"><i class="iconfont icon-home-fill"></i> Home</a></li><li class="nav-item"><a class="nav-link" href="/archives/"><i class="iconfont icon-archive-fill"></i> Archives</a></li><li class="nav-item"><a class="nav-link" href="/categories/"><i class="iconfont icon-category-fill"></i> Categories</a></li><li class="nav-item"><a class="nav-link" href="/tags/"><i class="iconfont icon-tags-fill"></i> Tags</a></li><li class="nav-item"><a class="nav-link" href="/about/"><i class="iconfont icon-user-fill"></i> About</a></li><li class="nav-item" id="search-btn"><a class="nav-link" data-toggle="modal" data-target="#modalSearch">&nbsp;<i class="iconfont icon-search"></i>&nbsp;</a></li><li class="nav-item" id="color-toggle-btn"><a class="nav-link" href="javascript:">&nbsp;<i class="iconfont icon-dark" id="color-toggle-icon"></i>&nbsp;</a></li></ul></div></div></nav><div class="banner" id="banner" parallax="true" style="background:url(/img/Royal_BluePetrol.jpg) no-repeat center center;background-size:cover"><div class="full-bg-img"><div class="mask flex-center" style="background-color:rgba(0,0,0,.3)"><div class="page-header text-center fade-in-up"><span class="h2" id="subtitle" title="Makefile应知应会"></span><div class="mt-3"><span class="post-meta mr-2"><i class="iconfont icon-author" aria-hidden="true"></i> LeeX0 </span><span class="post-meta"><i class="iconfont icon-date-fill" aria-hidden="true"></i> <time datetime="2021-08-30 14:30" pubdate>August 30, 2021 pm</time></span></div><div class="mt-1"><span class="post-meta mr-2"><i class="iconfont icon-chart"></i> 2k 字 </span><span class="post-meta mr-2"><i class="iconfont icon-clock-fill"></i> 24 分钟</span></div></div></div></div></div></header><main><div class="container-fluid nopadding-x"><div class="row nomargin-x"><div class="d-none d-lg-block col-lg-2"></div><div class="col-lg-8 nopadding-x-md"><div class="container nopadding-x-md" id="board-ctn"><div class="py-5" id="board"><article class="post-content mx-auto"><h1 style="display:none">Makefile应知应会</h1><div class="markdown-body"><blockquote><p><code>Makefile</code> 可以简单的认为是一个工程文件的编译规则，描述了整个工程的编译和链接等规则。其中包含了哪些文件需要编译，哪些文件不需要编译，哪些文件需要先编译，哪些文件需要后编译，哪些文件需要重建等等。编译整个工程需要涉及到的，在 <code>Makefile</code> 中都可以进行描述。换句话说，<code>Makefile</code> 可以使得我们的项目工程的编译变得自动化，不需要每次都手动输入一堆源文件和参数。</p><p>把要链接的库文件放在 <code>Makefile</code> 中，制定相应的规则和对应的链接顺序。这样只需要执行 <code>make</code> 命令，工程就会自动编译。每次想要编译工程的时候就执行 <code>make</code> ，省略掉手动编译中的参数选项和命令，非常的方便。</p><p><code>Makefile</code> 支持多线程并发操作，会极大的缩短我们的编译时间，并且当我们修改了源文件之后，编译整个工程的时候，<code>make</code> 命令只会编译我们修改过的文件，没有修改的文件不用重新编译，也极大的解决了我们耗费时间的问题。</p><p><code>gcc</code>使用相关内容见<a href="https://leex0.top/posts/4f2a16e6/">链接</a></p></blockquote><h2 id="1-格式"><a href="#1-格式" class="headerlink" title="1. 格式"></a>1. 格式</h2><div class="code-wrapper"><pre class="line-numbers language-text" data-language="text"><code class="language-text">targets : prerequisites
command</code></pre></div><p>相关说明如下：</p><ul><li>targets：规则的目标，可以是 Object File（一般称它为中间文件），也可以是可执行文件，还可以是一个标签；</li><li>prerequisites：是我们的依赖文件，要生成 targets 需要的文件或者是目标。可以是多个，也可以是没有；</li><li>command：make 需要执行的命令（任意的 shell 命令）。可以有多条命令，每一条命令占一行。</li></ul><p>Example：</p><div class="code-wrapper"><pre class="line-numbers language-makefile" data-language="makefile"><code class="language-makefile">test:test.c
gcc -o test test.c</code></pre></div><p>上述代码实现的功能就是编译 test.c 文件，通过这个实例可以详细的说明 Makefile 的具体的使用。其中 test 是的目标文件，也是我们的最终生成的可执行文件。依赖文件就是 test.c 源文件，重建目标文件需要执行的操作是<code>gcc -o test test.c</code>。这就是 Makefile 的基本的语法规则的使用。</p><p>使用 Makefile 的方式：首先需要编写好 Makefile 文件，然后在 shell 中执行 make 命令，程序就会自动执行，得到最终的目标文件。</p><h2 id="2-规则"><a href="#2-规则" class="headerlink" title="2. 规则"></a>2. 规则</h2><h3 id="2-1-显式规则"><a href="#2-1-显式规则" class="headerlink" title="2.1 显式规则"></a>2.1 显式规则</h3><p>显式规则说明了，如何生成一个或多的的目标文件。这是由 Makefile 的书写者明显指出，要生成的文件，文件的依赖文件，生成的命令。</p><h3 id="2-2隐晦规则"><a href="#2-2隐晦规则" class="headerlink" title="2.2隐晦规则"></a>2.2隐晦规则</h3><p>由于我们的 make 命名有自动推导的功能，所以隐晦的规则可以让我们比较粗糙地简略地书写 Makefile，这是由 make 命令所支持的。</p><h3 id="2-3-变量的定义"><a href="#2-3-变量的定义" class="headerlink" title="2.3 变量的定义"></a>2.3 变量的定义</h3><p>在 Makefile 中我们要定义一系列的变量，变量一般都是字符串，这个有点像C语言中的宏，当 Makefile 被执行时，其中的变量都会被扩展到相应的引用位置上。</p><h3 id="2-4-文件指示"><a href="#2-4-文件指示" class="headerlink" title="2.4 文件指示"></a>2.4 文件指示</h3><p>其包括了三个部分，一个是在一个 Makefile 中引用另一个 Makefile，就像C语言中的 include 一样；另一个是指根据某些情况指定 Makefile 中的有效部分，就像C语言中的预编译 if 一样；还有就是定义一个多行的命令。有关这一部分的内容，我会在后续的部分中讲述。</p><h3 id="2-5-注释"><a href="#2-5-注释" class="headerlink" title="2.5 注释"></a>2.5 注释</h3><p>Makefile 中只有行注释，和 UNIX 的 Shell 脚本一样，其注释是用“#”字符，这个就像 C/C++ 中的“//”一样。如果你要在你的 Makefile 中使用“#”字符，可以用反斜框进行转义，如：“#”。</p><h2 id="3-工作流程"><a href="#3-工作流程" class="headerlink" title="3. 工作流程"></a>3. 工作流程</h2><p>在我们编译项目文件的时候，默认情况下，make 执行的是 Makefile 中的第一规则（Makefile 中出现的第一个依赖关系），此规则的第一目标称之为“最终目标”或者是“终极目标”</p><div class="code-wrapper"><pre class="line-numbers language-makefile" data-language="makefile"><code class="language-makefile">main:main.o test1.o test2.o 《---终极  
gcc main.o test1.o test2.o -o main  
main.o:main.c test.h  
gcc -c main.c -o main.o  
test1.o:test1.c test.h  
gcc -c test1.c -o test1.o  
test2.o:test2.c test.h  
gcc -c test2.c -o test2.o</code></pre></div><p>对这些 “.o” 文件为目标的规则处理有下列三种情况：</p><ul><li>目标 “.o” 文件不存在，使用其描述规则创建它；</li><li>目标 “.o” 文件存在，目标 “.o” 文件所依赖文件在上一次 make 之后被修改过，则根据规则重新编译生成它；</li><li>目标 “.o” 文件存在，目标 “.o” 文件在上一次 make 之后没有被修改，则什么也不做。</li></ul><h2 id="4-变量定义与使用"><a href="#4-变量定义与使用" class="headerlink" title="4. 变量定义与使用"></a>4. 变量定义与使用</h2><p>调用变量的时候可以用 “$(VALUE_LIST)” 或者是 “${VALUE_LIST}” 来替换，这就是变量的引用。实例：</p><div class="code-wrapper"><pre class="line-numbers language-makefile" data-language="makefile"><code class="language-makefile">OBJ&#x3D;main.o test.o test1.o test2.o
test:$(OBJ) 
gcc -o test $(OBJ)</code></pre></div><h3 id="变量的基本赋值"><a href="#变量的基本赋值" class="headerlink" title="变量的基本赋值"></a>变量的基本赋值</h3><p>知道了如何定义，下面我们来说一下 Makefile 的变量的四种基本赋值方式：</p><ol><li>简单赋值 ( := ) 编程语言中常规理解的赋值方式，只对当前语句的变量有效。</li><li>递归赋值 ( = ) 赋值语句可能影响多个变量，所有目标变量相关的其他变量都受影响。</li><li>条件赋值 ( ?= ) 如果变量未定义，则使用符号中的值定义变量。如果该变量已经赋值，则该赋值语句无效。</li><li>追加赋值 ( += ) 原变量用空格隔开的方式追加一个新值。</li></ol><ul><li><p>简单赋值</p><div class="code-wrapper"><pre class="line-numbers language-makefile" data-language="makefile"><code class="language-makefile">x:&#x3D;foo
y:&#x3D;$(x)b
x:&#x3D;new
test：
@echo &quot;y&#x3D;&gt;$(y)&quot;
@echo &quot;x&#x3D;&gt;$(x)&quot;</code></pre></div><p>在 shell 命令行执行<code>make test</code>我们会看到:</p><div class="code-wrapper"><pre class="line-numbers language-text" data-language="text"><code class="language-text">y&#x3D;&gt;foob  
x&#x3D;&gt;new</code></pre></div></li><li><p>递归赋值</p><div class="code-wrapper"><pre class="line-numbers language-makefile" data-language="makefile"><code class="language-makefile">x&#x3D;foo
y&#x3D;$(x)b
x&#x3D;new
test：
@echo &quot;y&#x3D;&gt;$(y)&quot;
@echo &quot;x&#x3D;&gt;$(x)&quot;</code></pre></div><p>在 shell 命令行执行<code>make test</code>我们会看到:</p><div class="code-wrapper"><pre class="line-numbers language-text" data-language="text"><code class="language-text">y&#x3D;&gt;newb  
x&#x3D;&gt;new</code></pre></div></li><li><p>条件赋值</p><div class="code-wrapper"><pre class="line-numbers language-makefile" data-language="makefile"><code class="language-makefile">x:&#x3D;foo
y:&#x3D;$(x)b
x?&#x3D;new
test：
@echo &quot;y&#x3D;&gt;$(y)&quot;
@echo &quot;x&#x3D;&gt;$(x)&quot;</code></pre></div><p>在 shell 命令行执行<code>make test</code>我们会看到:</p><div class="code-wrapper"><pre class="line-numbers language-text" data-language="text"><code class="language-text">y&#x3D;&gt;foob  
x&#x3D;&gt;foo</code></pre></div></li><li><p>追加赋值</p><div class="code-wrapper"><pre class="line-numbers language-makefile" data-language="makefile"><code class="language-makefile">x:&#x3D;foo
y:&#x3D;$(x)b
x+&#x3D;$(y)
test：
@echo &quot;y&#x3D;&gt;$(y)&quot;
@echo &quot;x&#x3D;&gt;$(x)&quot;</code></pre></div><p>在 shell 命令行执行<code>make test</code>我们会看到:</p><div class="code-wrapper"><pre class="line-numbers language-text" data-language="text"><code class="language-text">y&#x3D;&gt;foob  
x&#x3D;&gt;foo foob</code></pre></div></li><li><p>自动化变量</p><div class="code-wrapper"><pre class="line-numbers language-makefile" data-language="makefile"><code class="language-makefile">test:test.o test1.o test2.o  
gcc -o $@ $^  
test.o:test.c test.h  
gcc -o $@ $&lt;  
test1.o:test1.c test1.h  
gcc -o $@ $&lt;  
test2.o:test2.c test2.h  
gcc -o $@ $&lt;</code></pre></div><p>这个规则模式中用到了 “$@” 、”$&lt;” 和 “$^” 这三个自动化变量，对比之前写的 Makefile 中的命令，我们可以发现 “$@” 代表的是目标文件test，“$^”代表的是依赖的文件，“$&lt;”代表的是依赖文件中的第一个。我们在执行 make 的时候，make 会自动识别命令中的自动化变量，并自动实现自动化变量中的值的替换，这个类似于编译C语言文件的时候的预处理的作用。</p></li></ul><h2 id="5-目标文件搜索"><a href="#5-目标文件搜索" class="headerlink" title="5. 目标文件搜索"></a>5. 目标文件搜索</h2><p>在 Makefile 中可以这样写：</p><div class="code-wrapper"><pre class="line-numbers language-text" data-language="text"><code class="language-text">VPATH :&#x3D; src</code></pre></div><p>我们可以这样理解，把 src 的值赋值给变量 VPATH，所以在执行 make 的时候会从 src 目录下找我们需要的文件。</p><p>当存在多个路径的时候我们可以这样写：</p><div class="code-wrapper"><pre class="line-numbers language-text" data-language="text"><code class="language-text">VPATH :&#x3D; src car</code></pre></div><h2 id="6-示例"><a href="#6-示例" class="headerlink" title="6. 示例"></a>6. 示例</h2><div class="code-wrapper"><pre class="line-numbers language-makefile" data-language="makefile"><code class="language-makefile">exe&#x3D;..&#x2F;release&#x2F;libA.so

### 链接目标文件
$(exe):libA.o
    gcc -o $(exe) -lstdc++ -fPIC -shared -Xlinker libA.o
    
### 编译源文件
libA.o:libA.cpp
    gcc -lstdc++ -c libA.cpp
    
clean:
 -rm *.out *.o *.bak

exe&#x3D;..&#x2F;release&#x2F;main.out
### 链接目标文件
### -L ..&#x2F;release  用于指定libA.so所在目录
### -lA  链接库文件libA.so
$(exe):main.o
    gcc -o $(exe) -lstdc++ -Xlinker main.o -L ..&#x2F;release -lA
    
### 编译源文件
main.o:main.cpp
 gcc -lstdc++ -c main.cpp
clean:
 -rm *.out *.o *.bak</code></pre></div><hr><blockquote><p>参考：<br><a target="_blank" rel="noopener" href="https://zhuanlan.zhihu.com/p/359033384">https://zhuanlan.zhihu.com/p/359033384</a></p></blockquote></div><hr><div><div class="post-metas mb-3"><div class="post-meta mr-3"><i class="iconfont icon-category"></i> <a class="hover-with-bg" href="/categories/%E5%AD%A6%E4%B9%A0%E7%AC%94%E8%AE%B0/">学习笔记</a> <a class="hover-with-bg" href="/categories/%E5%AD%A6%E4%B9%A0%E7%AC%94%E8%AE%B0/C/">C</a></div><div class="post-meta"><i class="iconfont icon-tags"></i> <a class="hover-with-bg" href="/tags/C-C/">C/C++</a> <a class="hover-with-bg" href="/tags/Makefile/">Makefile</a></div></div><p class="note note-warning">本博客所有文章除特别声明外，均采用 <a target="_blank" href="https://creativecommons.org/licenses/by-sa/4.0/deed.zh" rel="nofollow noopener noopener">CC BY-SA 4.0 协议</a> ，转载请注明出处！</p><div class="post-prevnext"><article class="post-prev col-6"></article><article class="post-next col-6"><a href="/posts/273a5d5/"><span class="hidden-mobile">《城南旧事》摘录</span> <span class="visible-mobile">Next</span> <i class="iconfont icon-arrowright"></i></a></article></div></div></article></div></div></div><div class="d-none d-lg-block col-lg-2 toc-container" id="toc-ctn"><div id="toc"><p class="toc-header"><i class="iconfont icon-list"></i>&nbsp;TOC</p><div class="toc-body" id="toc-body"></div></div></div></div></div><a id="scroll-top-button" href="#" role="button"><i class="iconfont icon-arrowup" aria-hidden="true"></i></a><div class="modal fade" id="modalSearch" tabindex="-1" role="dialog" aria-labelledby="ModalLabel" aria-hidden="true"><div class="modal-dialog modal-dialog-scrollable modal-lg" role="document"><div class="modal-content"><div class="modal-header text-center"><h4 class="modal-title w-100 font-weight-bold">Search</h4><button type="button" id="local-search-close" class="close" data-dismiss="modal" aria-label="Close"><span aria-hidden="true">&times;</span></button></div><div class="modal-body mx-3"><div class="md-form mb-5"><input type="text" id="local-search-input" class="form-control validate"> <label data-error="x" data-success="v" for="local-search-input">keyword</label></div><div class="list-group" id="local-search-result"></div></div></div></div></div></main><footer class="text-center mt-5 py-3"><div class="footer-content"><a href="https://hexo.io" target="_blank" rel="nofollow noopener"><span>Hexo</span></a> <i class="iconfont icon-love"></i> <a href="https://github.com/fluid-dev/hexo-theme-fluid" target="_blank" rel="nofollow noopener"><span>Fluid</span></a></div></footer><script src="https://cdn.jsdelivr.net/npm/nprogress@0.2.0/nprogress.min.js"></script><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/nprogress@0.2.0/nprogress.min.css"><script>NProgress.configure({showSpinner:!1,trickleSpeed:100}),NProgress.start(),window.addEventListener("load",(function(){NProgress.done()}))</script><script src="https://cdn.jsdelivr.net/npm/jquery@3.5.1/dist/jquery.min.js"></script><script src="https://cdn.jsdelivr.net/npm/bootstrap@4.5.3/dist/js/bootstrap.min.js"></script><script src="/js/debouncer.js"></script><script src="/js/events.js"></script><script src="/js/plugins.js"></script><script src="/js/img-lazyload.js"></script><script src="https://cdn.jsdelivr.net/npm/prismjs@1.22.0/components/prism-core.min.js"></script><script src="https://cdn.jsdelivr.net/npm/prismjs@1.22.0/plugins/autoloader/prism-autoloader.min.js"></script><script src="https://cdn.jsdelivr.net/npm/prismjs@1.22.0/plugins/line-numbers/prism-line-numbers.min.js"></script><script src="https://cdn.jsdelivr.net/npm/tocbot@4.12.0/dist/tocbot.min.js"></script><script src="https://cdn.jsdelivr.net/npm/@fancyapps/fancybox@3.5.7/dist/jquery.fancybox.min.js"></script><script src="https://cdn.jsdelivr.net/npm/anchor-js@4.3.0/anchor.min.js"></script><script defer src="https://cdn.jsdelivr.net/npm/clipboard@2.0.6/dist/clipboard.min.js"></script><script src="https://cdn.jsdelivr.net/npm/typed.js@2.0.11/lib/typed.min.js"></script><script>!function(t,i){(0,Fluid.plugins.typing)(i.getElementById("subtitle").title)}(window,document)</script><script src="/js/local-search.js"></script><script>$("#local-search-input").on("click",(function(){searchFunc("/local-search.xml","local-search-input","local-search-result")})),$("#modalSearch").on("shown.bs.modal",(function(){$("#local-search-input").focus()}))</script><script src="/js/boot.js"></script></body></html>